<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Haileybury Bhaluka Canteen System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --hb-maroon: #8b134a;
      --hb-maroon-dark: #701a3b;
      --hb-soft: #fdf2f8;
      --accent: #f97316;
      --bg: #f3f4f6;
      --text: #111827;
      --muted: #6b7280;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.18);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #8b134a;
      background-image: url("hb-logo.png");
      background-repeat: repeat;
      background-size: 220px auto;
      background-position: 0 0;
      background-attachment: fixed;
      color: var(--text);
      line-height: 1.5;
    }

    a { text-decoration: none; color: inherit; }

    .page {
      max-width: 1200px;
      margin: 20px auto 32px;
      padding: 16px 16px 32px;
      min-height: calc(100vh - 40px);
      background: rgba(249, 250, 251, 0.96);
      border-radius: 24px;
      box-shadow: 0 20px 55px rgba(15,23,42,0.45);
      backdrop-filter: blur(6px);
    }

    header {
      background: linear-gradient(135deg, rgba(139,19,74,0.98), #ec4899);
      color: #fdf2f8;
      border-bottom: 1px solid rgba(248,250,252,0.3);
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(136,19,55,0.4);
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 16px 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .brand-logo {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: #f5f5f5;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .brand-text-main {
      font-weight: 700;
      letter-spacing: 0.04em;
      font-size: 18px;
    }

    .brand-text-sub {
      font-size: 12px;
      color: #fee2f2;
    }

    .addr {
      font-size: 12px;
      text-align: right;
      color: #fee2f2;
    }

    main { margin-top: 18px; }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
      .addr { text-align: left; }
    }

    .panel {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209,213,219,0.9);
    }

    .panel h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .muted { font-size: 13px; color: var(--muted); }

    .role-tabs {
      display: flex;
      margin-top: 12px;
      border-radius: 999px;
      background: #f3f4f6;
      padding: 3px;
      gap: 4px;
    }

    .role-tab {
      flex: 1;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      font-weight: 500;
      transition: background 0.15s, color 0.15s, transform 0.1s;
    }

    .role-tab.active {
      background: #ffffff;
      color: var(--hb-maroon);
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15,23,42,0.12);
    }

    form {
      margin-top: 14px;
      display: grid;
      gap: 10px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: #374151;
    }

    input, select, textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
      font-family: inherit;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--hb-maroon);
      box-shadow: 0 0 0 1px rgba(136,19,55,0.4);
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
    }

    .btn-primary {
      background: var(--hb-maroon);
      color: #fef2f2;
      box-shadow: 0 12px 26px rgba(136,19,55,0.65);
    }

    .btn-primary:hover {
      background: var(--hb-maroon-dark);
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(136,19,55,0.75);
    }

    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
    }

    .small-text { font-size: 11px; color: var(--muted); }

    .alert {
      margin-top: 6px;
      font-size: 12px;
      color: #b91c1c;
    }

    .alert.success { color: #15803d; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 10px;
      border: 1px solid #bbf7d0;
      background: #ecfdf5;
      color: #166534;
    }

    .status-pill.closed {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .schedule-box {
      margin-top: 10px;
      padding: 9px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      font-size: 11px;
    }

    .schedule-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .schedule-list {
      list-style: none;
      display: grid;
      gap: 2px;
    }

    /* portals */

    .portal {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209,213,219,0.9);
      display: none;
    }

    .portal.active { display: block; }

    .portal-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .portal-header h2 { font-size: 18px; }

    .pill {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: var(--hb-soft);
      color: var(--hb-maroon-dark);
      border: 1px solid #fecdd3;
    }

    .logout-btn {
      font-size: 11px;
      cursor: pointer;
      color: #9ca3af;
      text-decoration: underline;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .toolbar label {
      font-size: 11px;
    }

    .toolbar select {
      width: auto;
      font-size: 11px;
      padding: 3px 7px;
    }

    .catalog {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px;
    }

    .item-card {
      border-radius: var(--radius-sm);
      border: 1px solid #e5e7eb;
      padding: 10px;
      font-size: 13px;
      background: #f9fafb;
      display: grid;
      gap: 4px;
      position: relative;
    }

    .item-name { font-weight: 600; }

    .item-meta { font-size: 11px; color: var(--muted); }

    .price {
      font-weight: 700;
      color: #16a34a;
      font-size: 13px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      display: inline-block;
    }

    .badge.drink { background: #dbf4ff; }
    .badge.ice { background: #e0f2fe; color: #0369a1; }
    .badge.snack { background: #fef3c7; color: #92400e; }

    .item-card button { justify-self: flex-start; margin-top: 4px; }

    .item-out {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
    }

    .cart {
      margin-top: 16px;
      border-top: 1px dashed #e5e7eb;
      padding-top: 10px;
    }

    .cart h3 { font-size: 15px; margin-bottom: 6px; }

    .cart-empty { font-size: 12px; color: var(--muted); }

    .cart-list {
      list-style: none;
      font-size: 12px;
      display: grid;
      gap: 4px;
      margin-bottom: 6px;
    }

    .cart-list span.qty { font-weight: 600; }

    .total {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .account-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      font-size: 11px;
    }

    .account-summary div span.label {
      display: block;
      color: #6b7280;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .account-summary div span.value {
      font-weight: 600;
      font-size: 13px;
    }

    .history-list {
      list-style: none;
      font-size: 11px;
      margin-top: 6px;
      display: grid;
      gap: 4px;
    }

    .history-list li {
      padding: 4px 6px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    .summary-table th,
    .summary-table td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: left;
    }

    .summary-table th {
      background: #f9fafb;
      font-weight: 600;
    }

    /* Admin table */

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 11px;
    }

    .tag-instock {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #dcfce7;
      color: #166534;
    }

    .tag-out {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
    }

    .admin-actions button {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
    }

    .admin-actions button:hover { background: #eef2ff; }

    .admin-form {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #e5e7eb;
      display: grid;
      gap: 8px;
      font-size: 12px;
    }

    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
<header>
  <div class="nav-inner">
    <div class="brand">
      <div class="brand-logo">
        <img src="hb-logo.png" alt="Haileybury Bhaluka logo">
      </div>
      <div>
        <div class="brand-text-main">Haileybury Bhaluka Canteen</div>
        <div class="brand-text-sub">Supermarket-style snacks, drinks & ice-cream</div>
      </div>
    </div>
    <div class="addr">
      Academic Building, 2nd Floor, Room 227<br>
      Haileybury Bhaluka<br>
      Housemaster: Mushfiqur Rahman Asif
    </div>
  </div>
</header>

<div class="page">
  <main class="layout">
    <!-- LEFT: LOGIN + SCHEDULE -->
    <section class="panel">
      <h2>Portal Login</h2>
      <p class="muted">
        Students, parents and admins can log in to order or manage canteen items.
      </p>

      <div class="role-tabs" id="roleTabs">
        <button class="role-tab active" data-role="student">Student</button>
        <button class="role-tab" data-role="parent">Parent</button>
        <button class="role-tab" data-role="admin">Admin</button>
      </div>

      <form id="loginForm">
        <div>
          <label for="username">Username</label>
          <input id="username" required autocomplete="off">
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" type="password" required>
        </div>
        <button type="submit" class="btn btn-primary">Log in</button>
      </form>

      <div id="openStatusPill" class="status-pill">
        Checking canteen status…
      </div>

      <div class="schedule-box">
        <div class="schedule-title">Canteen schedule</div>
        <ul class="schedule-list">
          <li><strong>Open:</strong> Saturday, 1:00 PM – 1:30 PM</li>
          <li><strong>Location:</strong> Academic Building, 2nd Floor, Room 227</li>
          <li><strong>Queries:</strong> Housemaster Mushfiqur Rahman Asif via school office.</li>
        </ul>
      </div>

      <div id="loginMsg" class="alert"></div>
    </section>

    <!-- RIGHT: PORTALS -->
    <section>
      <!-- Student portal -->
      <div id="studentPortal" class="portal">
        <div class="portal-header">
          <div>
            <h2>Student Portal</h2>
            <p class="muted">
              Order snacks, drinks & ice-cream and see your balance.
            </p>
          </div>
          <div>
            <span class="pill">Student account</span><br>
            <span class="logout-btn" onclick="logout()">Log out</span>
          </div>
        </div>

        <div class="account-summary" id="studentAccountSummary">
          <div>
            <span class="label">Student ID</span>
            <span class="value" id="accStudentId">–</span>
          </div>
          <div>
            <span class="label">Deposited</span>
            <span class="value" id="accDeposited">৳0</span>
          </div>
          <div>
            <span class="label">Spent</span>
            <span class="value" id="accSpent">৳0</span>
          </div>
          <div>
            <span class="label">Remaining</span>
            <span class="value" id="accRemaining">৳0</span>
          </div>
          <div>
            <span class="label">Amount to pay</span>
            <span class="value" id="accDue">৳0</span>
          </div>
        </div>

        <div class="small-text" style="margin-top:6px;">Order history (all orders)</div>
        <ul id="studentHistoryList" class="history-list"></ul>

        <div class="small-text" style="margin-top:8px;">Daily spending summary</div>
        <div id="studentDailySummaryWrapper">
          <!-- table will be injected -->
        </div>

        <div class="toolbar">
          <label>Filter:
            <select id="studentCategoryFilter">
              <option value="all">All items</option>
              <option value="snack">Snacks</option>
              <option value="drink">Drinks</option>
              <option value="ice-cream">Ice-cream</option>
            </select>
          </label>
        </div>
        <div class="catalog" id="studentCatalog"></div>

        <div class="cart" id="studentCartWrapper">
          <h3>Your Cart</h3>
          <div id="studentCartContent"></div>
        </div>

        <div class="cart" style="margin-top:16px;">
          <h3>Suggestion box</h3>
          <p class="small-text">Share ideas or issues about the canteen. Visible to staff only.</p>
          <form id="studentSuggestionForm">
            <textarea id="studentSuggestionText" placeholder="Write your suggestion here..."></textarea>
            <button type="submit" class="btn btn-ghost" style="margin-top:6px;">Send suggestion</button>
          </form>
          <div id="studentSuggestionMsg" class="alert"></div>
        </div>
      </div>

      <!-- Parent portal -->
      <div id="parentPortal" class="portal">
        <div class="portal-header">
          <div>
            <h2>Parent Portal</h2>
            <p class="muted">
              Place orders for your child and choose how you will pay.
            </p>
          </div>
          <div>
            <span class="pill">Parent access</span><br>
            <span class="logout-btn" onclick="logout()">Log out</span>
          </div>
        </div>

        <div class="account-summary" id="parentChildSummary">
          <div>
            <span class="label">Ordering for</span>
            <span class="value">
              <select id="parentChildSelect"></select>
            </span>
          </div>
          <div>
            <span class="label">Deposited</span>
            <span class="value" id="parentChildDeposited">৳0</span>
          </div>
          <div>
            <span class="label">Spent</span>
            <span class="value" id="parentChildSpent">৳0</span>
          </div>
          <div>
            <span class="label">Remaining</span>
            <span class="value" id="parentChildRemaining">৳0</span>
          </div>
          <div>
            <span class="label">Amount to pay</span>
            <span class="value" id="parentChildDue">৳0</span>
          </div>
        </div>

        <div class="small-text" style="margin-top:6px;">Daily spending summary for selected child</div>
        <div id="parentDailySummaryWrapper"></div>

        <div class="toolbar">
          <label>Filter:
            <select id="parentCategoryFilter">
              <option value="all">All items</option>
              <option value="snack">Snacks</option>
              <option value="drink">Drinks</option>
              <option value="ice-cream">Ice-cream</option>
            </select>
          </label>
        </div>
        <div class="catalog" id="parentCatalog"></div>

        <div class="cart" id="parentCartWrapper">
          <h3>Your Cart</h3>
          <div id="parentCartContent"></div>
        </div>

        <div class="cart" style="margin-top:16px;">
          <h3>Suggestion box</h3>
          <p class="small-text">Parents can leave feedback or requests for the canteen team.</p>
          <form id="parentSuggestionForm">
            <textarea id="parentSuggestionText" placeholder="Write your suggestion here..."></textarea>
            <button type="submit" class="btn btn-ghost" style="margin-top:6px;">Send suggestion</button>
          </form>
          <div id="parentSuggestionMsg" class="alert"></div>
        </div>
      </div>

      <!-- Admin portal -->
      <div id="adminPortal" class="portal">
        <div class="portal-header">
          <div>
            <h2>Admin Portal</h2>
            <p class="muted">
              Manage items, student accounts, deposits and suggestions.
            </p>
          </div>
          <div>
            <span class="pill">Canteen staff</span><br>
            <span class="logout-btn" onclick="logout()">Log out</span>
          </div>
        </div>

        <!-- Items table -->
        <table id="adminTable">
          <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Price (৳)</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Items form -->
        <form class="admin-form" id="adminAddForm">
          <strong>Add / Update Item</strong>
          <div>
            <label>Item name</label>
            <input id="adminItemName" required placeholder="e.g. Nutella Sandwich Pack">
          </div>
          <div>
            <label>Category</label>
            <select id="adminItemCategory">
              <option value="snack">Snack</option>
              <option value="drink">Drink</option>
              <option value="ice-cream">Ice-cream</option>
            </select>
          </div>
          <div>
            <label>Price (৳)</label>
            <input id="adminItemPrice" type="number" min="1" required>
          </div>
          <div>
            <label>Stock quantity</label>
            <input id="adminItemStock" type="number" min="0" required>
          </div>
          <button class="btn btn-primary" type="submit">Add / Update Item</button>
        </form>

        <!-- Student + parent accounts -->
        <form class="admin-form" id="adminStudentForm">
          <strong>Create / Link Student & Parent</strong>
          <div>
            <label>Student name</label>
            <input id="studentNameInput" required placeholder="e.g. Mahin Rahman">
          </div>
          <div>
            <label>Student ID / Username (leave empty to auto-generate)</label>
            <input id="studentIdInput" placeholder="e.g. FI10-060624">
          </div>
          <div>
            <label>Student password</label>
            <input id="studentPasswordInput" required type="text" placeholder="Choose a password">
          </div>
          <div>
            <label>Parent name</label>
            <input id="parentNameInput" placeholder="e.g. Rahman (Guardian)">
          </div>
          <div>
            <label>Parent username (login)</label>
            <input id="parentUsernameInput" placeholder="e.g. par_mahin">
          </div>
          <div>
            <label>Parent password</label>
            <input id="parentPasswordInput" type="text" placeholder="Parent password">
          </div>
          <button class="btn btn-primary" type="submit">Save student & parent</button>
        </form>

        <!-- Deposit management -->
        <form class="admin-form" id="adminAccountForm">
          <strong>Student deposits & balances</strong>
          <div>
            <label>Select student</label>
            <select id="accStudentSelect"></select>
          </div>
          <div id="accStudentInfo" class="small-text"></div>
          <div>
            <label>Add deposit (৳)</label>
            <input id="accDepositAmount" type="number" min="0">
          </div>
          <button class="btn btn-primary" type="button" id="accDepositBtn">Add deposit</button>
        </form>

        <!-- All student overview -->
        <div class="admin-form" id="adminStudentsOverviewPanel">
          <strong>All student accounts overview</strong>
          <table id="adminStudentsOverviewTable">
            <thead>
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Deposited</th>
              <th>Spent</th>
              <th>Remaining</th>
              <th>Owes</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Student order history (for admin) -->
        <div class="admin-form" id="adminStudentHistoryPanel">
          <strong>Student order history</strong>
          <div>
            <label>Select student</label>
            <select id="adminHistoryStudentSelect"></select>
          </div>
          <ul id="adminHistoryList" class="history-list"></ul>
        </div>

        <!-- Suggestions -->
        <div class="admin-form" id="adminSuggestionsPanel">
          <strong>Suggestions from students & guardians</strong>
          <ul id="adminSuggestionList" class="history-list"></ul>
        </div>

        <div id="adminMsg" class="alert"></div>
      </div>
    </section>
  </main>

  <footer>
    Haileybury Bhaluka Canteen – internal boarding school canteen system.
  </footer>
</div>

<script>
  /***************
   * DATA LAYER
   ***************/
  const STORAGE_ITEMS_KEY = 'hbSnackItemsV1';
  const STUDENTS_KEY = 'hbStudentsV1';
  const PARENTS_KEY = 'hbParentsV1';
  const SUGGESTIONS_KEY = 'hbSuggestionsV1';

  const defaultItems = [
    { id: 1,  name: 'Nutella Jar (Small)',        category: 'snack',     price: 250, stock: 15 },
    { id: 2,  name: 'Lays Classic Chips Pack',    category: 'snack',     price: 80,  stock: 40 },
    { id: 3,  name: 'Ruchi Chanachur Pack',       category: 'snack',     price: 50,  stock: 60 },
    { id: 4,  name: 'Mr. Noodles Chicken Packet', category: 'snack',     price: 60,  stock: 35 },
    { id: 5,  name: 'KitKat Chocolate Bar',       category: 'snack',     price: 70,  stock: 30 },
    { id: 6,  name: 'Oreo Biscuit Pack',          category: 'snack',     price: 60,  stock: 40 },
    { id: 7,  name: 'Coca-Cola Can 250ml',        category: 'drink',     price: 50,  stock: 50 },
    { id: 8,  name: 'Sprite Can 250ml',           category: 'drink',     price: 50,  stock: 50 },
    { id: 9,  name: 'Mango Juice Box 200ml',      category: 'drink',     price: 45,  stock: 45 },
    { id: 10, name: 'Chocolate Ice-cream Cup',    category: 'ice-cream', price: 80,  stock: 30 },
    { id: 11, name: 'Vanilla Ice-cream Stick',    category: 'ice-cream', price: 70,  stock: 30 }
  ];

  function loadJSON(key, fallback) {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    try {
      const parsed = JSON.parse(raw);
      if (parsed === null || parsed === undefined) return fallback;
      return parsed;
    } catch {
      return fallback;
    }
  }

  function saveJSON(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  let items = loadJSON(STORAGE_ITEMS_KEY, [...defaultItems]);
  let students = loadJSON(STUDENTS_KEY, {});
  let parents = loadJSON(PARENTS_KEY, {});
  let suggestions = loadJSON(SUGGESTIONS_KEY, []);

  function saveItems(list) {
    items = list;
    saveJSON(STORAGE_ITEMS_KEY, items);
  }

  function saveStudents(obj) {
    students = obj;
    saveJSON(STUDENTS_KEY, students);
  }

  function saveParents(obj) {
    parents = obj;
    saveJSON(PARENTS_KEY, parents);
  }

  function saveSuggestionsData(list) {
    suggestions = list;
    saveJSON(SUGGESTIONS_KEY, suggestions);
  }

  /***************
   * LOGIN
   ***************/
  const ADMIN_CREDENTIALS = { username: 'admin', password: 'hbadmin' };

  let currentRole = 'student';
  let currentUser = null;
  let currentParentChildId = null;

  const roleTabs = document.querySelectorAll('.role-tab');
  roleTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      roleTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentRole = tab.dataset.role;
      document.getElementById('loginMsg').textContent = '';
    });
  });

  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const msgEl = document.getElementById('loginMsg');

    if (!username || !password) {
      msgEl.textContent = 'Please enter both username and password.';
      msgEl.className = 'alert';
      return;
    }

    if (currentRole === 'admin') {
      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { role: 'admin', username };
        msgEl.textContent = '';
        document.getElementById('password').value = '';
        showPortal('admin');
        return;
      } else {
        msgEl.textContent = 'Incorrect username or password for admin portal.';
        msgEl.className = 'alert';
        return;
      }
    }

    if (currentRole === 'student') {
      const st = students[username];
      if (!st || st.password !== password) {
        msgEl.textContent = 'Incorrect username or password for student portal.';
        msgEl.className = 'alert';
        return;
      }
      currentUser = { role: 'student', username };
      msgEl.textContent = '';
      document.getElementById('password').value = '';
      showPortal('student');
      return;
    }

    if (currentRole === 'parent') {
      const p = parents[username];
      if (!p || p.password !== password) {
        msgEl.textContent = 'Incorrect username or password for parent portal.';
        msgEl.className = 'alert';
        return;
      }
      currentUser = { role: 'parent', username };
      msgEl.textContent = '';
      document.getElementById('password').value = '';
      showPortal('parent');
      return;
    }
  });

  function logout() {
    currentUser = null;
    currentParentChildId = null;
    document.getElementById('studentPortal').classList.remove('active');
    document.getElementById('parentPortal').classList.remove('active');
    document.getElementById('adminPortal').classList.remove('active');
    document.getElementById('loginMsg').textContent = '';
  }

  function showPortal(role) {
    document.getElementById('studentPortal').classList.remove('active');
    document.getElementById('parentPortal').classList.remove('active');
    document.getElementById('adminPortal').classList.remove('active');

    if (role === 'student') {
      document.getElementById('studentPortal').classList.add('active');
      renderCatalog('student');
      renderStudentAccountSummary();
    } else if (role === 'parent') {
      document.getElementById('parentPortal').classList.add('active');
      setupParentChildSelect();
      renderCatalog('parent');
    } else if (role === 'admin') {
      document.getElementById('adminPortal').classList.add('active');
      renderAdminTable();
      refreshStudentSelect();
      renderAdminAccountInfo();
      renderAdminStudentsOverview();
      renderAdminHistorySelect();
      renderAdminHistoryList();
      renderAdminSuggestions();
    }
  }

  /***************
   * SCHEDULE STATUS
   * Saturday 1:00–1:30 PM
   ***************/
  function updateOpenStatus() {
    const now = new Date();
    const day = now.getDay(); // 0 = Sun ... 6 = Sat
    const minutes = now.getHours() * 60 + now.getMinutes();
    const start = 13 * 60;
    const end = 13 * 60 + 30;
    const isSaturday = (day === 6);
    const open = isSaturday && minutes >= start && minutes < end;

    const pill = document.getElementById('openStatusPill');
    if (!pill) return;

    if (open) {
      pill.textContent = 'Canteen is OPEN now (Saturday, 1:00–1:30 PM).';
      pill.className = 'status-pill';
    } else {
      pill.textContent = 'Canteen next open: Saturday, 1:00–1:30 PM.';
      pill.className = 'status-pill closed';
    }
  }
  updateOpenStatus();
  setInterval(updateOpenStatus, 60000);

  /***************
   * CATALOG + CARTS
   ***************/
  const studentCart = {};
  const parentCart = {};

  function categoryBadge(cat) {
    if (cat === 'drink') return '<span class="badge drink">Drink</span>';
    if (cat === 'ice-cream') return '<span class="badge ice">Ice-cream</span>';
    return '<span class="badge snack">Snack</span>';
  }

  function getFilteredItems(role) {
    let filterValue = 'all';
    if (role === 'student') {
      const sel = document.getElementById('studentCategoryFilter');
      if (sel) filterValue = sel.value;
    } else if (role === 'parent') {
      const sel = document.getElementById('parentCategoryFilter');
      if (sel) filterValue = sel.value;
    }
    if (filterValue === 'all') return items;
    return items.filter(i => i.category === filterValue);
  }

  function renderCatalog(role) {
    const targetId = role === 'student' ? 'studentCatalog' : 'parentCatalog';
    const catalogEl = document.getElementById(targetId);
    if (!catalogEl) return;
    catalogEl.innerHTML = '';

    const list = getFilteredItems(role);

    list.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item-card';

      const inStock = item.stock > 0;
      div.innerHTML = `
        <div class="item-name">${item.name}</div>
        <div class="item-meta">
          ${categoryBadge(item.category)} •
          <span class="price">৳${item.price}</span>
        </div>
        <div class="item-meta">Available stock: ${item.stock}</div>
      `;

      if (!inStock) {
        const tag = document.createElement('div');
        tag.className = 'item-out';
        tag.textContent = 'Out of stock';
        div.appendChild(tag);
      } else {
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost';
        btn.textContent = 'Add to cart';
        btn.addEventListener('click', () => addToCart(role, item.id));
        div.appendChild(btn);
      }

      catalogEl.appendChild(div);
    });

    renderCart(role);
  }

  function addToCart(role, itemId) {
    const item = items.find(i => i.id === itemId);
    if (!item || item.stock <= 0) return;

    const cart = role === 'student' ? studentCart : parentCart;
    if (!cart[itemId]) cart[itemId] = 0;
    cart[itemId] += 1;
    if (cart[itemId] > item.stock) cart[itemId] = item.stock;

    renderCart(role);
  }

  function renderCart(role) {
    const cart = role === 'student' ? studentCart : parentCart;
    const wrapperId = role === 'student' ? 'studentCartContent' : 'parentCartContent';
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) return;

    const entries = Object.entries(cart).filter(([id, qty]) => qty > 0);
    if (entries.length === 0) {
      wrapper.innerHTML = '<div class="cart-empty">No items in cart yet.</div>';
      return;
    }

    let total = 0;
    const list = document.createElement('ul');
    list.className = 'cart-list';

    entries.forEach(([id, qty]) => {
      const item = items.find(i => i.id === Number(id));
      if (!item) return;
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="qty">${qty}×</span> ${item.name}
        – ৳${item.price * qty}
      `;
      list.appendChild(li);
      total += item.price * qty;
    });

    const totalEl = document.createElement('div');
    totalEl.className = 'total';
    totalEl.textContent = 'Total: ৳' + total;

    wrapper.innerHTML = '';
    wrapper.appendChild(list);
    wrapper.appendChild(totalEl);

    let paymentSelect = null;

    if (role === 'parent') {
      const container = document.createElement('div');
      container.style.marginBottom = '6px';
      const label = document.createElement('span');
      label.className = 'small-text';
      label.textContent = 'Payment method: ';

      paymentSelect = document.createElement('select');
      const optCash = document.createElement('option');
      optCash.value = 'Cash at canteen';
      optCash.textContent = 'Cash at canteen';
      const optCard = document.createElement('option');
      optCard.value = 'Card at canteen';
      optCard.textContent = 'Card at canteen';
      const optBkash = document.createElement('option');
      optBkash.value = 'bKash';
      optBkash.textContent = 'bKash';

      paymentSelect.appendChild(optCash);
      paymentSelect.appendChild(optCard);
      paymentSelect.appendChild(optBkash);

      label.appendChild(paymentSelect);
      container.appendChild(label);
      wrapper.appendChild(container);
    }

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary';
    btn.textContent = 'Place order';
    btn.addEventListener('click', () => {
      let method = 'Student account / pay at canteen';
      if (role === 'parent' && paymentSelect) {
        method = paymentSelect.value;
      }
      placeOrder(role, entries, total, method);
    });

    wrapper.appendChild(btn);
  }

  function placeOrder(role, entries, total, paymentMethod) {
    if (!entries.length) return;

    // Determine student ID
    let studentId = null;
    if (role === 'student' && currentUser) {
      studentId = currentUser.username;
    } else if (role === 'parent') {
      studentId = currentParentChildId;
    }

    if (!studentId || !students[studentId]) {
      alert('No student account linked for this order. Please contact the canteen admin.');
      return;
    }

    // Update stock
    entries.forEach(([id, qty]) => {
      const idx = items.findIndex(i => i.id === Number(id));
      if (idx !== -1) {
        items[idx].stock = Math.max(0, items[idx].stock - qty);
      }
    });
    saveItems(items);

    // Update student record
    const st = students[studentId];
    if (!st.history) st.history = [];
    if (typeof st.spent !== 'number') st.spent = 0;

    st.spent += total;

    const orderItems = entries.map(([id, qty]) => {
      const item = items.find(i => i.id === Number(id));
      return {
        id: Number(id),
        name: item ? item.name : ('Item ' + id),
        qty,
        price: item ? item.price : 0
      };
    });

    st.history.push({
      time: new Date().toISOString(),
      total,
      paymentMethod,
      items: orderItems
    });

    saveStudents(students);
    renderStudentAccountSummary();
    refreshStudentSelect();
    renderAdminAccountInfo();
    renderAdminStudentsOverview();
    renderAdminHistoryList();

    alert(
      'Order placed for ' + (st.name || studentId) +
      '.\nTotal: ৳' + total +
      '\nPayment: ' + paymentMethod
    );

    // Clear cart
    const cart = role === 'student' ? studentCart : parentCart;
    Object.keys(cart).forEach(k => delete cart[k]);

    renderCatalog('student');
    renderCatalog('parent');
    renderAdminTable();
  }

  /***************
   * DAILY SUMMARY HELPER
   ***************/
  function buildDailySummary(history) {
    const summary = {};
    if (!Array.isArray(history)) return summary;
    history.forEach(order => {
      if (!order || !order.time || typeof order.total !== 'number') return;
      const d = new Date(order.time);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const key = `${yyyy}-${mm}-${dd}`;
      if (!summary[key]) summary[key] = { total: 0, count: 0 };
      summary[key].total += order.total;
      summary[key].count += 1;
    });
    return summary;
  }

  function renderDailySummaryForStudent(studentId, wrapperId) {
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) return;
    wrapper.innerHTML = '';

    const st = students[studentId];
    if (!st || !Array.isArray(st.history) || st.history.length === 0) {
      const div = document.createElement('div');
      div.className = 'small-text';
      div.textContent = 'No spending data yet.';
      wrapper.appendChild(div);
      return;
    }

    const summary = buildDailySummary(st.history);
    const dates = Object.keys(summary).sort();

    if (dates.length === 0) {
      const div = document.createElement('div');
      div.className = 'small-text';
      div.textContent = 'No spending data yet.';
      wrapper.appendChild(div);
      return;
    }

    const table = document.createElement('table');
    table.className = 'summary-table';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Date</th><th>Orders</th><th>Total spent (৳)</th></tr>';
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    dates.forEach(date => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${date}</td>
        <td>${summary[date].count}</td>
        <td>${summary[date].total}</td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);
  }

  /***************
   * STUDENT ACCOUNT SUMMARY
   ***************/
  function renderStudentAccountSummary() {
    if (!currentUser || currentUser.role !== 'student') return;
    const uname = currentUser.username;
    const st = students[uname];
    if (!st) return;

    const deposited = typeof st.deposited === 'number' ? st.deposited : 0;
    const spent = typeof st.spent === 'number' ? st.spent : 0;
    const remaining = deposited - spent;
    const due = remaining < 0 ? -remaining : 0;

    document.getElementById('accStudentId').textContent = st.id || uname;
    document.getElementById('accDeposited').textContent = '৳' + deposited;
    document.getElementById('accSpent').textContent = '৳' + spent;
    document.getElementById('accRemaining').textContent = '৳' + (remaining > 0 ? remaining : 0);
    document.getElementById('accDue').textContent = '৳' + due;

    const historyList = document.getElementById('studentHistoryList');
    historyList.innerHTML = '';

    if (!st.history || st.history.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No orders yet.';
      historyList.appendChild(li);
    } else {
      st.history.slice().reverse().forEach(order => {
        const li = document.createElement('li');
        const dt = new Date(order.time);
        const timeStr = dt.toLocaleString();
        const itemsStr = (order.items || [])
          .map(i => `${i.qty}× ${i.name}`)
          .join(', ');
        li.textContent = `${timeStr} – ${itemsStr} (৳${order.total}, ${order.paymentMethod})`;
        historyList.appendChild(li);
      });
    }

    renderDailySummaryForStudent(uname, 'studentDailySummaryWrapper');
  }

  /***************
   * PARENT CHILD SELECT
   ***************/
  function setupParentChildSelect() {
    if (!currentUser || currentUser.role !== 'parent') return;
    const select = document.getElementById('parentChildSelect');
    if (!select) return;

    const p = parents[currentUser.username];
    select.innerHTML = '';

    if (!p || !Array.isArray(p.childIds) || p.childIds.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No linked student (ask admin to link)';
      opt.disabled = true;
      opt.selected = true;
      select.appendChild(opt);
      currentParentChildId = null;
      updateParentChildSummary(null);
      return;
    }

    p.childIds.forEach(id => {
      const st = students[id];
      if (!st) return;
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = id + ' – ' + (st.name || 'Student');
      select.appendChild(opt);
    });

    currentParentChildId = p.childIds[0];
    updateParentChildSummary(currentParentChildId);

    select.onchange = () => {
      currentParentChildId = select.value || null;
      updateParentChildSummary(currentParentChildId);
    };
  }

  function updateParentChildSummary(studentId) {
    const depEl = document.getElementById('parentChildDeposited');
    const spEl = document.getElementById('parentChildSpent');
    const remEl = document.getElementById('parentChildRemaining');
    const dueEl = document.getElementById('parentChildDue');

    if (!studentId || !students[studentId]) {
      depEl.textContent = '৳0';
      spEl.textContent = '৳0';
      remEl.textContent = '৳0';
      dueEl.textContent = '৳0';
      document.getElementById('parentDailySummaryWrapper').innerHTML =
        '<div class="small-text">No student selected.</div>';
      return;
    }

    const st = students[studentId];
    const deposited = typeof st.deposited === 'number' ? st.deposited : 0;
    const spent = typeof st.spent === 'number' ? st.spent : 0;
    const remaining = deposited - spent;
    const due = remaining < 0 ? -remaining : 0;

    depEl.textContent = '৳' + deposited;
    spEl.textContent = '৳' + spent;
    remEl.textContent = '৳' + (remaining > 0 ? remaining : 0);
    dueEl.textContent = '৳' + due;

    renderDailySummaryForStudent(studentId, 'parentDailySummaryWrapper');
  }

  /***************
   * ADMIN – ITEMS
   ***************/
  function renderAdminTable() {
    const tbody = document.querySelector('#adminTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    items.forEach(item => {
      const tr = document.createElement('tr');

      const status = item.stock > 0
        ? '<span class="tag-instock">In stock</span>'
        : '<span class="tag-out">Out of stock</span>';

      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.category}</td>
        <td>${item.price}</td>
        <td>${item.stock}</td>
        <td>${status}</td>
        <td class="admin-actions">
          <button data-id="${item.id}" data-action="edit">Edit</button>
          <button data-id="${item.id}" data-action="toggle">
            ${item.stock > 0 ? 'Make 0 stock' : 'Set stock 10'}
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        if (action === 'edit') preloadItemInForm(id);
        if (action === 'toggle') toggleStock(id);
      });
    });
  }

  function preloadItemInForm(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    document.getElementById('adminItemName').value = item.name;
    document.getElementById('adminItemCategory').value = item.category;
    document.getElementById('adminItemPrice').value = item.price;
    document.getElementById('adminItemStock').value = item.stock;
  }

  function toggleStock(id) {
    items = items.map(i => {
      if (i.id === id) {
        return { ...i, stock: i.stock > 0 ? 0 : 10 };
      }
      return i;
    });
    saveItems(items);
    renderAdminTable();
    renderCatalog('student');
    renderCatalog('parent');
  }

  document.getElementById('adminAddForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('adminItemName').value.trim();
    const category = document.getElementById('adminItemCategory').value;
    const price = Number(document.getElementById('adminItemPrice').value);
    const stock = Number(document.getElementById('adminItemStock').value);
    const msgEl = document.getElementById('adminMsg');

    if (!name || price <= 0 || stock < 0) {
      msgEl.textContent = 'Please fill all item fields with valid values.';
      msgEl.className = 'alert';
      return;
    }

    const existing = items.find(i => i.name.toLowerCase() === name.toLowerCase());
    if (existing) {
      existing.category = category;
      existing.price = price;
      existing.stock = stock;
      msgEl.textContent = 'Item updated: ' + name;
    } else {
      const newId = items.length ? Math.max(...items.map(i => i.id)) + 1 : 1;
      items.push({ id: newId, name, category, price, stock });
      msgEl.textContent = 'Item added: ' + name;
    }
    msgEl.className = 'alert success';
    saveItems(items);
    renderAdminTable();
    renderCatalog('student');
    renderCatalog('parent');
    e.target.reset();
  });

  /***************
   * ADMIN – STUDENT & PARENT CREATION
   ***************/
  function generateStudentId(name) {
    const initials = name.split(/\s+/)
      .filter(Boolean)
      .map(p => p[0].toUpperCase())
      .join('')
      .slice(0, 3);
    const now = new Date();
    const dd = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yy = String(now.getFullYear()).slice(-2);
    return initials + dd + mm + yy; // e.g. MR060624
  }

  document.getElementById('adminStudentForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const studentName = document.getElementById('studentNameInput').value.trim();
    let studentId = document.getElementById('studentIdInput').value.trim();
    const studentPassword = document.getElementById('studentPasswordInput').value.trim();
    const parentName = document.getElementById('parentNameInput').value.trim();
    const parentUsername = document.getElementById('parentUsernameInput').value.trim();
    const parentPassword = document.getElementById('parentPasswordInput').value.trim();
    const msgEl = document.getElementById('adminMsg');

    if (!studentName || !studentPassword) {
      msgEl.textContent = 'Student name and password are required.';
      msgEl.className = 'alert';
      return;
    }

    if (!studentId) {
      studentId = generateStudentId(studentName);
    }

    // Create or update student
    if (!students[studentId]) {
      students[studentId] = {
        id: studentId,
        name: studentName,
        password: studentPassword,
        parentUsername: parentUsername || null,
        deposited: 0,
        spent: 0,
        history: []
      };
    } else {
      const st = students[studentId];
      st.name = studentName;
      st.password = studentPassword;
      st.parentUsername = parentUsername || st.parentUsername || null;
      if (typeof st.deposited !== 'number') st.deposited = 0;
      if (typeof st.spent !== 'number') st.spent = 0;
      if (!Array.isArray(st.history)) st.history = [];
    }

    // Create or link parent
    if (parentUsername) {
      if (!parents[parentUsername]) {
        parents[parentUsername] = {
          name: parentName || parentUsername,
          password: parentPassword || 'changeme',
          childIds: [studentId]
        };
      } else {
        const p = parents[parentUsername];
        if (!Array.isArray(p.childIds)) p.childIds = [];
        if (!p.childIds.includes(studentId)) p.childIds.push(studentId);
        if (parentName) p.name = parentName;
        if (parentPassword) p.password = parentPassword;
      }
    }

    saveStudents(students);
    saveParents(parents);
    msgEl.textContent =
      'Student and parent information saved. Student ID / username: ' + studentId;
    msgEl.className = 'alert success';

    refreshStudentSelect();
    renderAdminAccountInfo();
    renderAdminStudentsOverview();
    renderAdminHistorySelect();

    e.target.reset();
  });

  /***************
   * ADMIN – DEPOSITS & BALANCES
   ***************/
  const accSelect = document.getElementById('accStudentSelect');
  const accInfo = document.getElementById('accStudentInfo');
  const accDepositInput = document.getElementById('accDepositAmount');
  const accDepositBtn = document.getElementById('accDepositBtn');

  function refreshStudentSelect() {
    if (!accSelect) return;
    accSelect.innerHTML = '';

    const ids = Object.keys(students);
    if (ids.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No students yet';
      opt.disabled = true;
      opt.selected = true;
      accSelect.appendChild(opt);
      return;
    }

    ids.forEach(id => {
      const st = students[id];
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = id + ' – ' + (st.name || 'Student');
      accSelect.appendChild(opt);
    });
  }

  function renderAdminAccountInfo() {
    if (!accSelect || !accInfo) return;
    const sid = accSelect.value;
    if (!sid || !students[sid]) {
      accInfo.textContent = 'Select a student to see balances.';
      return;
    }
    const st = students[sid];
    const deposited = typeof st.deposited === 'number' ? st.deposited : 0;
    const spent = typeof st.spent === 'number' ? st.spent : 0;
    const remaining = deposited - spent;
    const due = remaining < 0 ? -remaining : 0;

    accInfo.textContent =
      (st.name || sid) +
      ' | Deposited: ৳' + deposited +
      ' • Spent: ৳' + spent +
      ' • Remaining: ৳' + (remaining > 0 ? remaining : 0) +
      (due > 0 ? ' • Owes: ৳' + due : '');
  }

  if (accSelect && accDepositBtn) {
    accSelect.addEventListener('change', () => {
      renderAdminAccountInfo();
      renderAdminHistoryList();
    });

    accDepositBtn.addEventListener('click', () => {
      const sid = accSelect.value;
      const amount = Number(accDepositInput.value);
      if (!sid || !students[sid] || !(amount > 0)) return;

      const st = students[sid];
      if (typeof st.deposited !== 'number') st.deposited = 0;
      st.deposited += amount;
      saveStudents(students);
      accDepositInput.value = '';
      renderAdminAccountInfo();
      renderStudentAccountSummary();
      renderAdminStudentsOverview();

      const msgEl = document.getElementById('adminMsg');
      msgEl.textContent = 'Added ৳' + amount + ' deposit for ' + (st.name || sid);
      msgEl.className = 'alert success';
    });
  }

  /***************
   * ADMIN – STUDENT OVERVIEW TABLE
   ***************/
  function renderAdminStudentsOverview() {
    const table = document.getElementById('adminStudentsOverviewTable');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    const ids = Object.keys(students);
    if (ids.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.textContent = 'No students yet.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    ids.forEach(id => {
      const st = students[id];
      const deposited = typeof st.deposited === 'number' ? st.deposited : 0;
      const spent = typeof st.spent === 'number' ? st.spent : 0;
      const remaining = deposited - spent;
      const due = remaining < 0 ? -remaining : 0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${id}</td>
        <td>${st.name || ''}</td>
        <td>৳${deposited}</td>
        <td>৳${spent}</td>
        <td>৳${remaining > 0 ? remaining : 0}</td>
        <td>৳${due}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  /***************
   * ADMIN – HISTORY VIEWER
   ***************/
  const adminHistorySelect = document.getElementById('adminHistoryStudentSelect');
  const adminHistoryList = document.getElementById('adminHistoryList');

  function renderAdminHistorySelect() {
    if (!adminHistorySelect) return;
    adminHistorySelect.innerHTML = '';

    const ids = Object.keys(students);
    if (ids.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No students yet';
      opt.disabled = true;
      opt.selected = true;
      adminHistorySelect.appendChild(opt);
      return;
    }

    ids.forEach(id => {
      const st = students[id];
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = id + ' – ' + (st.name || 'Student');
      adminHistorySelect.appendChild(opt);
    });
  }

  function renderAdminHistoryList() {
    if (!adminHistoryList || !adminHistorySelect) return;
    adminHistoryList.innerHTML = '';

    const sid = adminHistorySelect.value || accSelect.value;
    if (!sid || !students[sid]) {
      const li = document.createElement('li');
      li.textContent = 'Select a student to view order history.';
      adminHistoryList.appendChild(li);
      return;
    }

    const st = students[sid];
    if (!st.history || st.history.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No orders yet for this student.';
      adminHistoryList.appendChild(li);
      return;
    }

    st.history.slice().reverse().forEach(order => {
      const li = document.createElement('li');
      const dt = new Date(order.time);
      const timeStr = dt.toLocaleString();
      const itemsStr = (order.items || [])
        .map(i => `${i.qty}× ${i.name}`)
        .join(', ');
      li.textContent =
        `${timeStr} – ${itemsStr} (৳${order.total}, ${order.paymentMethod})`;
      adminHistoryList.appendChild(li);
    });
  }

  if (adminHistorySelect) {
    adminHistorySelect.addEventListener('change', renderAdminHistoryList);
  }

  /***************
   * SUGGESTIONS
   ***************/
  function renderAdminSuggestions() {
    const list = document.getElementById('adminSuggestionList');
    if (!list) return;
    list.innerHTML = '';

    if (!suggestions || suggestions.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No suggestions yet.';
      list.appendChild(li);
      return;
    }

    suggestions.slice().reverse().forEach(s => {
      const li = document.createElement('li');
      const dt = new Date(s.time);
      const timeStr = dt.toLocaleString();
      li.textContent =
        '[' + timeStr + '] ' +
        s.fromRole + ' ' +
        (s.fromUser ? '(' + s.fromUser + ')' : '') +
        ': ' + s.message;
      list.appendChild(li);
    });
  }

  const studentSuggestionForm = document.getElementById('studentSuggestionForm');
  const studentSuggestionText = document.getElementById('studentSuggestionText');
  const studentSuggestionMsg = document.getElementById('studentSuggestionMsg');

  if (studentSuggestionForm) {
    studentSuggestionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = studentSuggestionText.value.trim();
      if (!currentUser || currentUser.role !== 'student') {
        studentSuggestionMsg.textContent = 'Please log in as a student to send a suggestion.';
        studentSuggestionMsg.className = 'alert';
        return;
      }
      if (!msg) {
        studentSuggestionMsg.textContent = 'Please write a suggestion before sending.';
        studentSuggestionMsg.className = 'alert';
        return;
      }
      suggestions.push({
        time: new Date().toISOString(),
        fromRole: 'student',
        fromUser: currentUser.username,
        message: msg
      });
      saveSuggestionsData(suggestions);
      studentSuggestionText.value = '';
      studentSuggestionMsg.textContent = 'Suggestion sent. Thank you.';
      studentSuggestionMsg.className = 'alert success';
      renderAdminSuggestions();
    });
  }

  const parentSuggestionForm = document.getElementById('parentSuggestionForm');
  const parentSuggestionText = document.getElementById('parentSuggestionText');
  const parentSuggestionMsg = document.getElementById('parentSuggestionMsg');

  if (parentSuggestionForm) {
    parentSuggestionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = parentSuggestionText.value.trim();
      if (!currentUser || currentUser.role !== 'parent') {
        parentSuggestionMsg.textContent = 'Please log in as a parent to send a suggestion.';
        parentSuggestionMsg.className = 'alert';
        return;
      }
      if (!msg) {
        parentSuggestionMsg.textContent = 'Please write a suggestion before sending.';
        parentSuggestionMsg.className = 'alert';
        return;
      }
      suggestions.push({
        time: new Date().toISOString(),
        fromRole: 'parent',
        fromUser: currentUser.username,
        message: msg
      });
      saveSuggestionsData(suggestions);
      parentSuggestionText.value = '';
      parentSuggestionMsg.textContent = 'Suggestion sent. Thank you.';
      parentSuggestionMsg.className = 'alert success';
      renderAdminSuggestions();
    });
  }

  /***************
   * FILTER EVENT LISTENERS
   ***************/
  const studentFilter = document.getElementById('studentCategoryFilter');
  if (studentFilter) {
    studentFilter.addEventListener('change', () => renderCatalog('student'));
  }

  const parentFilter = document.getElementById('parentCategoryFilter');
  if (parentFilter) {
    parentFilter.addEventListener('change', () => renderCatalog('parent'));
  }

  // Initial passive renders so page is not empty
  renderCatalog('student');
  refreshStudentSelect();
  renderAdminStudentsOverview();
  renderAdminHistorySelect();
  renderAdminSuggestions();
</script>
</body>
</html>
